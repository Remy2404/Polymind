name: Nightly

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  nightly:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "latest"

    - name: Install dependencies
      run: |
        uv sync --dev

    - name: Run full test suite
      run: |
        uv run pytest tests/ -v --tb=long --durations=10

    - name: Check for broken links in documentation
      run: |
        find docs/ -name "*.md" -exec grep -l "http" {} \; | head -5 | xargs -I {} sh -c 'echo "Checking {}"; curl -s -o /dev/null -w "%{http_code}" $(grep -o "http[^)]*" {}) | grep -v 200 || true' || true

    - name: Clean up old branches
      run: |
        git branch -r | grep -E "origin/(feature|bugfix|hotfix)" | head -10 || true

    - name: Check disk usage
      run: |
        df -h
        du -sh . --exclude=.git

    - name: Send nightly report
      if: always()
      run: |
        echo "Nightly build completed at $(date)" > nightly-report.txt
        echo "Test results: $?" >> nightly-report.txt
      shell: bash